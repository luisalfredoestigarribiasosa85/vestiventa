#!/bin/bash
set -e
echo "=== Iniciando migraciones de base de datos ==="

# Esperar a que la base de datos esté lista
echo "Esperando a que la base de datos esté lista..."
for i in {1..15}; do
  if bundle exec rails runner "ActiveRecord::Base.connection_pool.with_connection { |con| con.active? }" >/dev/null 2>&1; then
    break
  fi
  echo "Intento $i/15 - Base de datos no disponible, esperando..."
  sleep 2
done

# Ejecutar migraciones
echo "Ejecutando migraciones..."
bundle exec rails db:prepare

echo "=== Migraciones completadas ==="
exit 0
#!/bin/bash
set -e
echo "=== Iniciando precompilación de assets ==="

# Configuración temporal para evitar conexión a la base de datos
export RAILS_ENV=production
export DISABLE_DATABASE_ENVIRONMENT_CHECK=1

# Usar una base de datos SQLite temporal
export DATABASE_URL="sqlite3:db/precompile.sqlite3"

# Configurar una clave secreta temporal si no existe
if [ -z "$SECRET_KEY_BASE" ] && [ -z "$RAILS_MASTER_KEY" ]; then
  echo "ADVERTENCIA: No se encontró SECRET_KEY_BASE ni RAILS_MASTER_KEY"
  echo "Usando clave temporal para la precompilación..."
  export SECRET_KEY_BASE=dummy_key_for_precompile_phase
fi

# Crear directorio de assets
mkdir -p tmp/cache

# Ejecutar la precompilación
echo "Ejecutando precompilación de assets..."

# Forzar la precompilación sin verificar la base de datos
bundle exec rake assets:precompile || \
  echo "ADVERTENCIA: Falló la precompilación, continuando sin ella"

echo "=== Precompilación completada ==="
exit 0
#!/bin/bash
set -e

echo "=== Iniciando precompilación de assets ==="

# Configurar una clave secreta temporal si no existe
if [ -z "$SECRET_KEY_BASE" ] && [ -z "$RAILS_MASTER_KEY" ]; then
  echo "ADVERTENCIA: No se encontró SECRET_KEY_BASE ni RAILS_MASTER_KEY"
  echo "Usando clave temporal para la precompilación..."
  export SECRET_KEY_BASE=dummy_key_for_precompile_phase
fi

# Forzar modo de assets sin base de datos
export RAILS_ENV=assets
export DATABASE_URL=postgresql://user:pass@localhost/nonexistent_db

# Ejecutar la precompilación
echo "Ejecutando precompilación de assets..."

# Desactivar temporalmente la verificación de la base de datos
DISABLE_DATABASE_ENVIRONMENT_CHECK=1 \
bundle exec rake assets:precompile || \
  echo "ADVERTENCIA: Falló la precompilación, continuando sin ella"

echo "=== Precompilación completada ==="
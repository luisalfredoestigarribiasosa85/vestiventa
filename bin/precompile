#!/bin/bash
set -e
echo "=== Iniciando precompilación de assets ==="

# Usar entorno de producción
export RAILS_ENV=production

# Deshabilitar verificación de base de datos
export DISABLE_DATABASE_ENVIRONMENT_CHECK=1

# Configurar una clave secreta temporal si no existe
if [ -z "$SECRET_KEY_BASE" ] && [ -z "$RAILS_MASTER_KEY" ]; then
  echo "ADVERTENCIA: No se encontró SECRET_KEY_BASE ni RAILS_MASTER_KEY"
  echo "Usando clave temporal para la precompilación..."
  export SECRET_KEY_BASE=dummy_key_for_precompile_phase
fi

# Crear directorio de assets
mkdir -p tmp/cache

# Ejecutar la precompilación
echo "Ejecutando precompilación de assets..."
bundle exec rake assets:precompile || \
  echo "ADVERTENCIA: Falló la precompilación, continuando sin ella"

echo "=== Precompilación completada ==="
exit 0